{"version":3,"sources":["user.js"],"names":[],"mappings":"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","file":"user-compiled.js","sourcesContent":["var mongoose = require('mongoose')\r\nvar co = require('co');\r\nvar User = mongoose.model('User')\r\nvar users = require('../api/users')\r\nvar bcrypt = require('bcryptjs')\r\nvar SALT_WORK_FACTOR = 10\r\n\r\n// signup\r\nexports.showSignup = function *(next) {\r\n  yield this.render('pages/signup', {\r\n    title: '注册页面'\r\n  })\r\n}\r\n\r\nexports.showSignin = function *(next) {\r\n  yield this.render('pages/signin', {\r\n    title: '登录页面'\r\n  })\r\n}\r\n\r\nexports.signup = function *(next) {\r\n  var _user = this.request.body.user\r\n  var res = yield p.query('select * from users where name=? limit 1',[_user.name])\r\n  if (res && res.length > 0) {\r\n    this.redirect('/signin')\r\n    yield next\r\n  }\r\n  else {\r\n    var salt = bcrypt.genSaltSync(SALT_WORK_FACTOR);\r\n    var hash = bcrypt.hashSync(_user.password, salt);\r\n    _user.password = hash\r\n    var newUser = yield users.saveUser(_user)\r\n    this.session.user = newUser\r\n    this.redirect('/')\r\n  }\r\n}\r\n\r\n// signin\r\nexports.signin = function *(next) {\r\n  var _user = this.request.body.user\r\n  var name = _user.name\r\n  var password = _user.password\r\n\r\n  var res  = yield p.query('select id,name,password from users where name = ?',[name])\r\n  var user = res[0]\r\n\r\n  if (!user) {\r\n    this.redirect('/signup')\r\n    return next\r\n  }\r\n\r\n  var isMatch = yield users.comparePassword(password,user.password)\r\n\r\n  if (isMatch) {\r\n    this.session.user = user\r\n    return this.redirect('/')\r\n    yield next\r\n  }\r\n  else {\r\n    return this.redirect('/signin')\r\n    yield next\r\n  }\r\n}\r\n\r\n// logout\r\nexports.logout =  function *(next) {\r\n  delete this.session.user\r\n  //delete app.locals.user\r\n\r\n  this.redirect('/')\r\n}\r\n\r\n// userlist page\r\nexports.list = function *(next) {\r\n  var users = yield  User.find({}).sort('meta.updateAt').exec()\r\n  yield this.render('pages/userlist', {\r\n    title: 'imooc 用户列表页',\r\n    users: users\r\n  })\r\n}\r\n\r\n// midware for user\r\nexports.signinRequired = function *(next) {\r\n  var user = this.session.user\r\n  if (!user) {\r\n    this.redirect('/signin')\r\n  }else{\r\n    yield next\r\n  }\r\n}\r\n\r\nexports.adminRequired = function *(next) {\r\n  var user = this.session.user\r\n  if (user.role <= 10) {\r\n    this.redirect('/signin')\r\n  }else{\r\n    yield next\r\n  }\r\n}"]}